function r(t){if(!penpot.utils.types.isRectangle(t)&&!penpot.utils.types.isEllipse(t))return!1;const e=t.fills;return!e||!Array.isArray(e)?!1:e.some(a=>a.fillImage)}function p(t){if(!penpot.utils.types.isRectangle(t)&&!penpot.utils.types.isEllipse(t))return;const e=t.fills;if(!(!e||!Array.isArray(e)))return e.find(a=>a.fillImage)}const l="https://maskrdotio.github.io/plugin-penpot";penpot.ui.open("Maskr.io",`${l}/?theme=${penpot.theme}`,{width:360,height:600});o();penpot.on("themechange",t=>{penpot.ui.sendMessage({type:"theme-change",payload:{theme:t}})});penpot.on("selectionchange",()=>{o()});penpot.ui.onMessage(t=>{switch(t.type){case"get-selection":o();break;case"export-image":c(t.payload);break;case"create-image-from-data":d(t.payload);break}});function o(){const e=penpot.selection.filter(a=>(r(a),!0)).map(a=>({id:a.id,name:a.name}));penpot.ui.sendMessage({type:"selection-change",payload:{count:e.length,images:e}})}async function c(t){try{const e=penpot.selection.find(n=>n.id===t.id);if(!e){penpot.ui.sendMessage({type:"error",payload:{message:"Shape not found"}});return}let a;const i=p(e);if(i?.fillImage){a=await i.fillImage.data(),penpot.ui.sendMessage({type:"image-data",payload:{id:t.id,data:Array.from(a)}});return}a=await e.export({type:"png",scale:1}),penpot.ui.sendMessage({type:"image-data",payload:{id:t.id,data:Array.from(a)}})}catch(e){penpot.ui.sendMessage({type:"error",payload:{message:e instanceof Error?e.message:"Export failed"}})}}async function d(t){try{const e=penpot.selection.find(s=>s.id===t.sourceId);if(!e){console.error("Source shape not found"),penpot.ui.sendMessage({type:"error",payload:{message:"Source shape not found"}});return}const a=new Uint8Array(t.data),i=await penpot.uploadMediaData(t.name,a,"image/png"),n=penpot.createRectangle();n&&(n.name=t.name,n.x=e.x+e.width+20,n.y=e.y,n.resize(e.width,e.height),n.fills=[{fillOpacity:1,fillImage:i}]),penpot.ui.sendMessage({type:"image-created",payload:{success:!0}})}catch(e){console.error("Failed to create image:",e),penpot.ui.sendMessage({type:"error",payload:{message:e instanceof Error?e.message:"Failed to create image"}})}}
